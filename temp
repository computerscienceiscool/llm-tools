#!/bin/bash
# Cleanup script for llm-runtime duplicate code
# Review each removal before running!

echo "=== LLM-Runtime Duplicate Code Cleanup ==="
echo ""
echo "The following files in internal/ are duplicates of files in pkg/"
echo "and should be removed:"
echo ""

# Files to remove (duplicates)
DUPLICATES=(
    "internal/cli/scanner.go"           # duplicate of pkg/scanner/scanner.go
    "internal/command/parser.go"        # duplicate of pkg/scanner/parser.go
    "internal/command/types.go"         # duplicate of pkg/scanner/types.go
    "internal/security/path.go"         # duplicate of pkg/sandbox/path.go
    "internal/security/extension.go"    # duplicate of pkg/sandbox/extension.go
    "internal/security/exec_validation.go"  # duplicate of pkg/sandbox/exec_validation.go
    "internal/security/audit.go"        # duplicate of pkg/sandbox/audit.go
    "internal/docker/client.go"         # duplicate of pkg/sandbox/client.go
    "internal/docker/container.go"      # duplicate of pkg/sandbox/container.go
)

for file in "${DUPLICATES[@]}"; do
    if [ -f "$file" ]; then
        echo "  - $file"
    fi
done

echo ""
echo "Files that may be dead code (verify before removing):"
echo "  - internal/cli/process.go  (ProcessText may be unused)"
echo ""

read -p "Do you want to check if these files are imported anywhere? (y/n) " -n 1 -r
echo ""

if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo ""
    echo "=== Checking imports ==="
    for file in "${DUPLICATES[@]}"; do
        pkg=$(dirname "$file" | sed 's/\//\./g')
        echo ""
        echo "Checking for imports of: $pkg"
        grep -r "\"github.com/computerscienceiscool/llm-runtime/$pkg\"" --include="*.go" . 2>/dev/null || echo "  No imports found"
    done
fi

echo ""
read -p "Do you want to DELETE the duplicate files? (y/n) " -n 1 -r
echo ""

if [[ $REPLY =~ ^[Yy]$ ]]; then
    for file in "${DUPLICATES[@]}"; do
        if [ -f "$file" ]; then
            echo "Removing: $file"
            rm "$file"
        fi
    done
    
    # Remove empty directories
    echo ""
    echo "Cleaning up empty directories..."
    rmdir internal/command 2>/dev/null && echo "Removed: internal/command/"
    rmdir internal/security 2>/dev/null && echo "Removed: internal/security/"
    rmdir internal/docker 2>/dev/null && echo "Removed: internal/docker/"
    
    echo ""
    echo "Done! Run 'go build ./...' to verify everything still compiles."
fi
